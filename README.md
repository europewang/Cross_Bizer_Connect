# 贝塞尔曲线线要素连接工具

## 项目简介

贝塞尔曲线线要素连接工具是一个专为ArcGIS Desktop设计的Python脚本工具，用于在线要素之间创建平滑的贝塞尔曲线连接。该工具通过智能的斜率分组算法，自动识别和连接相关的线要素，生成美观且符合几何原理的贝塞尔曲线，并直接添加到输入要素类中。

## 功能特性

### 核心功能
- **智能分组**: 根据线要素的斜率自动分为A、B两组
- **头尾相连**: 严格遵循几何学原理，只允许线的起点连接另一线的终点
- **距离优化**: 在符合连接原则的前提下，选择距离最近的端点进行连接
- **平滑曲线**: 使用二次贝塞尔曲线算法生成平滑的连接线
- **智能控制点**: 通过延长线交点计算最佳控制点位置
- **直接写入**: 生成的贝塞尔曲线直接添加到输入要素类中，无需单独输出文件

### 辅助功能
- **回退机制**: 当斜率分组失败时，自动切换到成对连接模式
- **参数可调**: 支持自定义斜率容差、曲线饱满度和平滑度
- **错误处理**: 完善的异常处理和用户友好的错误提示
- **详细日志**: 提供执行过程的详细信息和统计数据

## 系统要求

- **软件环境**: ArcGIS Desktop 10.x 或更高版本
- **Python版本**: Python 2.7（ArcGIS内置）
- **操作系统**: Windows 7/8/10/11
- **依赖库**: arcpy（ArcGIS自带）、math（Python标准库）

## 安装和使用

### 创建自定义脚本工具

#### 1. 准备脚本文件
- 确保您已经下载了 `connect_lines_with_bezier.py` 脚本文件
- 将脚本保存到您的工作目录中

#### 2. 创建新工具箱
- 在ArcMap中打开ArcToolbox
- 右键点击ArcToolbox根节点
- 选择 **Add Toolbox** > **New Toolbox**
- 为工具箱命名（例如："贝塞尔曲线工具"）

#### 3. 添加脚本工具
- 右键点击新创建的工具箱
- 选择 **Add** > **Script**
- 在脚本工具向导中填写：
  - **Name**: `BezierConnect`
  - **Label**: `使用贝塞尔曲线连接线`
  - **Description**: `使用贝塞尔曲线连接线要素的工具`
- 点击 **Next**

#### 4. 配置脚本源
- 在 **Script File** 旁边，点击文件夹图标，然后浏览并选择您之前保存的Python脚本 `connect_lines_with_bezier.py`
- 确保下面的 **Run Python script in process** 选项没有被勾选
- 点击 **Next**

#### 5. 配置脚本工具 - 参数
这是最关键的一步，您需要在这里定义脚本的输入参数。请按照下面的说明添加四个参数：

**参数 0: 输入线要素**
- **Display Name**: `输入线要素`
- **Data Type**: `Feature Set`
- **Parameter Properties**:
  - **Direction**: `Input`
- 在 **Feature Set** 的 **Schema** 中，点击 **...** 按钮，设置 **Geometry Type** 为 `Polyline`，并导入您数据对应的空间参考

**参数 1: 曲线饱满度**
- **Display Name**: `曲线饱满度`
- **Data Type**: `Double`
- **Default Value**: `0.5` (您可以根据需要设置默认值)
- **Parameter Properties**:
  - **Direction**: `Input`

**参数 2: 曲线平滑度**
- **Display Name**: `曲线平滑度(点数)`
- **Data Type**: `Long`
- **Default Value**: `20` (点数越多，曲线越平滑)
- **Parameter Properties**:
  - **Direction**: `Input`

**参数 3: 连接方式**
- **Display Name**: `是否采用曲线连接`
- **Data Type**: `Boolean`
- **Default Value**: `True` (True=曲线连接，False=直线连接)
- **Parameter Properties**:
  - **Direction**: `Input`

- 完成参数设置后，点击 **Finish**

## 如何使用新创建的工具

1. 在ArcMap中，打开您想要处理的线要素图层
2. 启动编辑会话 (**Editor** > **Start Editing**)
3. 在地图上选择您想要连接的两条或多条（必须是偶数条）线段
4. 在ArcToolbox中，双击您刚刚创建的 **使用贝塞尔曲线连接线** 工具
5. 在工具对话框中：
   - **输入线要素**: 这里会自动填充您在编辑会话中选择的要素
   - **曲线饱满度**: 根据需要调整此值，值越大，曲线越弯曲（仅在曲线连接模式下有效）
   - **曲线平滑度**: 根据需要调整此值，值越大，曲线越平滑（仅在曲线连接模式下有效）
   - **是否采用曲线连接**: 选择连接方式
     - **True（勾选）**: 采用贝塞尔曲线连接，按斜率分为AB两组
     - **False（不勾选）**: 采用直线连接，按距离分为CD两组
6. 点击 **OK**，脚本将执行并根据选择的连接方式在输入要素类中添加生成的曲线或直线

## 参数说明

| 参数 | 类型 | 范围 | 默认值 | 说明 |
|------|------|------|--------|---------|
| 输入线要素 | Feature Set | - | - | 需要连接的线要素集合，生成的连接线将直接添加到此要素类中 |
| 曲线饱满度 | Double | 0.1-1.0 | 0.5 | 控制曲线的弯曲程度，值越大越弯曲（仅曲线连接模式有效） |
| 曲线平滑度 | Long | 2-200 | 20 | 控制曲线的点密度，值越大越平滑（仅曲线连接模式有效） |
| 是否采用曲线连接 | Boolean | True/False | True | 选择连接方式：True=贝塞尔曲线连接，False=直线连接 |

### 参数调优建议

- **曲线饱满度**：
  - 0.1-0.3：轻微弯曲，适合技术图纸
  - 0.4-0.6：中等弯曲，适合一般用途
  - 0.7-1.0：强烈弯曲，适合艺术效果

- **曲线平滑度**：
  - 10-30点：快速预览，较粗糙
  - 20-50点：标准质量，推荐使用
  - 80-200点：高质量，用于最终输出

## 连接原则

脚本严格遵循"头尾相连"原则，根据选择的连接方式采用不同的分组策略：

### 曲线连接模式（按斜率分组）

**分组规则**：根据线段斜率分为A、B两组

✅ **允许的连接**：
- A组线起点 → B组线终点
- A组线终点 → B组线起点

❌ **不允许的连接**：
- A组线起点 → B组线起点
- A组线终点 → B组线终点

### 直线连接模式（按距离分组）

**分组规则**：根据线段间距离分为C、D两组，优先连接距离最近的线段对

✅ **允许的连接**：
- C组线起点 → D组线终点
- C组线终点 → D组线起点

❌ **不允许的连接**：
- C组线起点 → D组线起点
- C组线终点 → D组线终点

## 故障排除

### 常见问题

1. **脚本执行失败**
   - 检查输入数据是否为线要素
   - 确认输出路径有写入权限
   - 查看ArcGIS消息窗口的错误信息

2. **没有生成连接线**
   - 检查选中的线要素数量（至少需要2条）
   - 调整斜率容差参数（曲线连接模式）
   - 查看警告信息了解跳过原因

3. **连接效果不理想**
   - **曲线连接模式**：调整饱满度因子和曲线点数
   - **直线连接模式**：检查线段分组是否合理
   - 尝试切换连接方式
   - 检查输入线要素的几何质量

### 调试模式

脚本包含详细的日志输出，可通过ArcGIS消息窗口查看：
- 分组结果信息
- 连接尝试详情
- 错误和警告信息
- 最终统计结果

## 技术支持

如遇到问题，请检查：
1. ArcGIS版本兼容性
2. Python环境配置
3. 输入数据格式和质量
4. 参数设置合理性

## 版本历史

- **v1.0**：基础贝塞尔曲线连接功能
- **v2.0**：添加斜率分组和头尾相连逻辑
- **v2.1**：优化错误处理和回退机制
- **v2.2**：改进端点距离计算逻辑
- **v2.3**：简化参数配置，移除输出路径参数，贝塞尔曲线直接写入输入要素类
- **v3.0**：新增连接方式选择功能，支持曲线连接（按斜率分AB组）和直线连接（按距离分CD组）两种模式

## 许可证

本项目仅供学习和研究使用。